<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="assets/style.css?t=d358ee59">
    <script src="assets/script.js?t=42463e55"></script>
    <title>Iris</title>
    <meta name="viewport" content="width=device-width">
  </head>
  <body class="-menu-visible">
    <div class="doc-layout">
      <div class="toggle menu-toggle js-menu-toggle"></div>
      <div class="menu toc-menu">
        <li class="menu-item -level-0 -parent">
          <ul class="submenu">
            <li class="menu-item -level-1"><a class="link title -active link-index" href="index.html">Iris</a>
            </li>
            <li class="menu-item -level-1"><a class="link title link-iris" href="#iris">Iris</a>
            </li>
            <li class="menu-item -level-1"><a class="link title link-contents" href="#contents">Contents</a>
            </li>
            <li class="menu-item -level-1 -parent"><a class="link title link-flow" href="#flow">Flow</a>
              <ul class="submenu">
                <li class="menu-item -level-2"><a class="link title link-dispatcher" href="#dispatcher">Dispatcher</a>
                </li>
                <li class="menu-item -level-2"><a class="link title link-plugins" href="#plugins">Plugins</a>
                </li>
              </ul>
            </li>
            <li class="menu-item -level-1 -parent"><a class="link title link-getting-started" href="#getting-started">Getting started</a>
              <ul class="submenu">
                <li class="menu-item -level-2"><a class="link title link-1.-create-an-empty-project" href="#1.-create-an-empty-project">1. Create an empty project</a>
                </li>
                <li class="menu-item -level-2"><a class="link title link-2.-add-flows" href="#2.-add-flows">2. Add flows</a>
                </li>
                <li class="menu-item -level-2"><a class="link title link-3.-run-flows" href="#3.-run-flows">3. Run flows</a>
                </li>
              </ul>
            </li>
            <li class="menu-item -level-1 -parent"><a class="link title link-writing-plugins" href="#writing-plugins">Writing plugins</a>
              <ul class="submenu">
                <li class="menu-item -level-2"><a class="link title link-docks" href="#docks">Docks</a>
                </li>
                <li class="menu-item -level-2"><a class="link title link-handlers" href="#handlers">Handlers</a>
                </li>
                <li class="menu-item -level-2"><a class="link title link-hooks" href="#hooks">Hooks</a>
                </li>
              </ul>
            </li>
            <li class="menu-item -level-1"><a class="link title link-requirements" href="#requirements">Requirements</a>
            </li>
            <li class="menu-item -level-1"><a class="link title link-github" href="#github">Github</a>
            </li>
          </ul>
        </li>
      </div>
      <div class="body page-index">
        <div class="header-nav">
          <div class="right">
          </div>
        </div>
        <div class="markdown-body"><p align="center">
    <img src="https://github.com/gcba-iris/iris/raw/master/assets/img/logo.png" alt="Iris">
</p>
<p align="center">
    <a href="https://travis-ci.org/gcba-iris/iris">
        <img src="https://travis-ci.org/gcba-iris/iris.svg?branch=master" alt="Build Status">
    </a>
        <a href="https://www.codacy.com/app/zeta/iris?utm_source=github.com&amp;utm_medium=referral&amp;utm_content=gcba-iris/iris&amp;utm_campaign=Badge_Grade">
        <img src="https://api.codacy.com/project/badge/Grade/8f1241b15304485bbaefa6cf5d390214" alt="Codacy Status">
    </a>
    <a href="https://codecov.io/gh/gcba-iris/iris">
        <img src="https://codecov.io/gh/gcba-iris/iris/branch/master/graph/badge.svg" alt="Coverage Status">
    </a>
</p>
<hr>
<h3 id="iris">Iris</h3>
<p>A tiny Node.js framework for building fast, modular &amp; extensible IoT backends. Assemble data processing flows in a Gulp-like fashion using third-party plugins, or write your own. Run the app. That&apos;s it.</p>
<p>Iris tries to strike a balance between convention vs configuration. It comes with sane defaults and a plugin system that makes it easy to get started, while allowing ample flexibility at the same time.</p>
<pre><code class="lang-bash">$ npm install gcba-iris/iris -g
</code></pre>
<h2 id="contents">Contents</h2>
<ul>
<li><a href="#flow">1 Flow</a></li>
<li><a href="#getting-started">2 Getting started</a>
<ul>
<li><a href="#1-create-an-empty-project">2.1 Create an empty project</a>
<ul>
<li><a href="#existing-project">2.1.1 Existing project</a></li>
</ul>
</li>
<li><a href="#2-add-flows">2.2 Add flows</a>
<ul>
<li><a href="#method-signature">2.2.1 Method signature</a></li>
<li><a href="#sample-irisfilejs">2.2.2 Sample irisfile.js</a></li>
</ul>
</li>
<li><a href="#3-run-flows">2.3 Run flows</a></li>
</ul>
</li>
<li><a href="#requirements">3 Requirements</a></li>
<li><a href="#learn-more">4 Learn more</a></li>
</ul>
<h2 id="flow">Flow</h2>
<p><img src="https://github.com/gcba-iris/iris/raw/master/assets/img/architecture.png" alt="Architecture"></p>
<p>Iris is built around the <strong>flow</strong>, which is the path a message follows from the moment it arrives to the moment it gets handled/processed. If a response is generated, the flow will include its way back to the original device.</p>
<p>Data flows are processed in parallel using threads. A message will always remain within a single thread from start to finish, so if a thread goes down only the messages within will be affected.</p>
<pre><code>--&gt; Dock --&gt; Dispatcher --&gt; Hooks --&gt; Handler
Handler --&gt; Dispatcher --&gt; Hooks --&gt; Dock --&gt;
</code></pre>
<h3 id="dispatcher">Dispatcher</h3>
<p>Receives the data object from the <strong>dock</strong>, calls the registered <strong>input hooks</strong> and routes the data object to the right <strong>handler</strong>. Similarly, when there&apos;s a response the dispatcher routes it to the right <strong>dock</strong> and executes the registered <strong>output hooks</strong>.</p>
<p>The dispatcher is part of the Iris core and cannot be customized or swapped off - it&apos;s the glue that holds everything together.</p>
<h3 id="plugins">Plugins</h3>
<h4 id="dock">Dock</h4>
<p>Listens to a single port for incoming messages through a specific protocol and parses it into a plain javascript object. Then passes this object along to the dispatcher. If a response comes back, the dock serializes it to match the message format and sends it off to the original device.</p>
<h5 id="sample-message">Sample message</h5>
<pre><code>tag1|subtag1|02,56,58,8|subtag2|sds,sd,wtr,ghd
</code></pre>
<p>The flow tag is the first part of the message. It allows Iris to know how to route the message to the right handler. Therefore, a tag must be unique and belong to a single flow.
Subtags, on the other hand, are optional.</p>
<h4 id="handler">Handler</h4>
<p>Processes the data object received from the dispatcher. A handler can generate a response, which goes back to the dispatcher. The response will be serialized and sent by the respective dock. If there&apos;s no response the data flow ends there.</p>
<h4 id="hooks">Hooks</h4>
<p>A hook is just a callback function that gets executed whenever a piece of data passes by the dispatcher in the course of a data flow. Multiple hooks can be tied to a single flow. Each hook can be set to run when the message object comes in (input hook) or when the response goes out (output hook).</p>
<h2 id="getting-started">Getting started</h2>
<h3 id="1.-create-an-empty-project">1. Create an empty project</h3>
<pre><code class="lang-bash">$ iris new myApp
</code></pre>
<p>Creates a new folder called <code>myApp</code> with the following contents:</p>
<pre><code>myApp/
|___modules/
|   |___docks/
|   |___handlers/
|   |___hooks/
|___irisfile.js
|___package.json
</code></pre>
<p>Then runs <code>npm install</code>.</p>
<h4 id="existing-project">Existing project</h4>
<pre><code class="lang-bash">$ iris init
</code></pre>
<p>Creates an empty Irisfile and runs <code>npm install gcba-iris/iris --save</code>.</p>
<h3 id="2.-add-flows">2. Add flows</h3>
<p>The data flows are defined in the Irisfile, using <code>iris.flow()</code>.</p>
<h4 id="method-signature">Method signature</h4>
<pre><code class="lang-javascript">iris.flow(name, config);
</code></pre>
<ul>
<li><strong>name</strong>: A string identifier.</li>
<li><strong>config</strong>: An object containing:
<ul>
<li><strong>tag</strong>: A unique string.</li>
<li><strong>docks</strong>: An array of dock instances.</li>
<li><strong>handler</strong>: The handler instance.</li>
<li><strong>inputHooks</strong> <em>(optional)</em>:  An array of hook instances.</li>
<li><strong>outputHooks</strong> <em>(optional)</em>: An array of hook instances.</li>
</ul>
</li>
</ul>
<h4 id="sample-irisfile.js">Sample irisfile.js</h4>
<pre><code class="lang-javascript"><span class="pl-k">const</span> iris = <span class="pl-c1">require</span>(<span class="pl-s">&apos;iris&apos;</span>);
<span class="pl-k">const</span> dock = <span class="pl-c1">require</span>(<span class="pl-s">&apos;./docks/http&apos;</span>);
<span class="pl-k">const</span> handler = <span class="pl-c1">require</span>(<span class="pl-s">&apos;./handlers/handler1&apos;</span>);
<span class="pl-k">const</span> anotherHandler = <span class="pl-c1">require</span>(<span class="pl-s">&apos;./handlers/handler2&apos;</span>);
<span class="pl-k">const</span> hook1 = <span class="pl-c1">require</span>(<span class="pl-s">&apos;./hooks/hook1&apos;</span>);
<span class="pl-k">const</span> hook2 = <span class="pl-c1">require</span>(<span class="pl-s">&apos;./hooks/hook2&apos;</span>);

iris.config = {
    <span class="hljs-attr">threads</span>: <span class="hljs-number">4</span>,
    <span class="hljs-attr">logLevel</span>: <span class="pl-s">&apos;warn&apos;</span>,
};

dock.config = {
    <span class="hljs-attr">port</span>: <span class="hljs-number">5000</span>
};

iris.flow(<span class="pl-s">&apos;Flow 1&apos;</span>, {
    <span class="hljs-attr">tag</span>: <span class="pl-s">&apos;tag1&apos;</span>,
    <span class="hljs-attr">docks</span>: [dock],
    <span class="hljs-attr">handler</span>: handler,
    <span class="hljs-attr">inputHooks</span>: [hook1],
    <span class="hljs-attr">outputHooks</span>: [hook2]
});

iris.flow(<span class="pl-s">&apos;Flow 2&apos;</span>, {
    <span class="hljs-attr">tag</span>: <span class="pl-s">&apos;tag2&apos;</span>,
    <span class="hljs-attr">docks</span>: [dock],
    <span class="hljs-attr">handler</span>: anotherHandler,
    <span class="hljs-attr">inputHooks</span>: [hook2]
});
</code></pre>
<p>The default amount of threads is the number of CPU cores.</p>
<h3 id="3.-run-flows">3. Run flows</h3>
<p>Inside a project directory:</p>
<pre><code class="lang-bash">$ iris
</code></pre>
<p><img src="https://github.com/gcba-iris/iris/raw/master/assets/img/running.png" alt="Iris screenshot"></p>
<h2 id="writing-plugins">Writing plugins</h2>
<p>All plugins must extend their base classes. Take a look at the <a href="https://gcba-iris.github.io/iris-tech-docs">technical docs</a> for an in-depth explanation of the architecture and API reference.</p>
<h3 id="docks">Docks</h3>
<p>You must implement <code>get path()</code>, <code>listen()</code> and <code>stop()</code>. <code>send()</code> is optional.</p>
<h5 id="sample-http-dock">Sample HTTP dock</h5>
<pre><code class="lang-javascript"><span class="hljs-meta">&apos;use strict&apos;</span>;

<span class="pl-k">const</span> Dock = <span class="pl-c1">require</span>(<span class="pl-s">&apos;iris&apos;</span>).Dock;
<span class="pl-k">const</span> http = <span class="pl-c1">require</span>(<span class="pl-s">&apos;http&apos;</span>);
<span class="pl-k">const</span> requestIp = <span class="pl-c1">require</span>(<span class="pl-s">&apos;request-ip&apos;</span>);

<span class="hljs-class"><span class="pl-k">class</span> <span class="pl-ent">HTTPDock</span> <span class="pl-k">extends</span> <span class="pl-ent">Dock</span> </span>{
    <span class="pl-k">constructor</span>(name, protocol) {
        <span class="pl-k">super</span>(name, protocol);

        <span class="pl-k">this</span>._server = <span class="pl-c1">null</span>;
        <span class="pl-k">this</span>._listening = <span class="pl-c1">false</span>;
    }

    get path() {
        <span class="pl-k">return</span> __filename;
    }

    listen() {
        <span class="pl-k">this</span>._server = http.createServer(<span class="pl-k">this</span>._handleRequest.bind(<span class="pl-k">this</span>));

        <span class="pl-k">if</span> (!<span class="pl-k">this</span>._listening) {
            <span class="pl-k">this</span>._server.listen(<span class="pl-k">this</span>.config.port, () =&gt; {
                <span class="pl-k">this</span>._listening = <span class="pl-c1">true</span>;
                <span class="pl-k">this</span>.logger.info(<span class="pl-s">&apos;[HTTP Dock] Listening on port &apos;</span> + <span class="pl-k">this</span>.config.port + <span class="pl-s">&apos;...&apos;</span>);
            });
        }
    }

    stop() {
        <span class="pl-k">if</span> (<span class="pl-k">this</span>._listening) {
            <span class="pl-k">this</span>._server.close();
            <span class="pl-k">this</span>._listening = <span class="pl-c1">false</span>;
            <span class="pl-k">this</span>.logger.info(<span class="pl-s">&apos;[HTTP Dock] Stopped listening&apos;</span>);
        }
    }

    _handleRequest(request, response) {
        <span class="pl-k">const</span> chunks = [];
        <span class="pl-k">const</span> meta = {
            <span class="hljs-attr">ip</span>: requestIp.getClientIp(request)
        };

        request.on(<span class="pl-s">&apos;data&apos;</span>, <span class="hljs-function"><span class="pl-k">function</span> (<span class="hljs-params">chunk</span>) </span>{
            chunks.push(chunk);
        });

        request.on(<span class="pl-s">&apos;end&apos;</span>, <span class="hljs-function"><span class="pl-k">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="pl-k">const</span> data = Buffer.concat(chunks);

            <span class="pl-k">this</span>.process(data, meta, (message) =&gt; {
                response.statusCode = <span class="hljs-number">200</span>;

                <span class="pl-k">if</span> (message) {
                    response.write(message);
                    <span class="pl-k">this</span>.logger.verbose(<span class="pl-s">&apos;Sent response to client&apos;</span>);
                } <span class="pl-k">else</span> response.end();
            });
        }.bind(<span class="pl-k">this</span>));
    }
}

<span class="pl-c1">module</span>.exports = <span class="pl-k">new</span> HTTPDock(<span class="pl-s">&apos;http&apos;</span>, <span class="pl-s">&apos;HTTP&apos;</span>);
</code></pre>
<h3 id="handlers">Handlers</h3>
<p>You must implement <code>get path()</code> and <code>handle()</code>.</p>
<h5 id="sample-handler">Sample handler</h5>
<pre><code class="lang-javascript"><span class="hljs-meta">&apos;use strict&apos;</span>;

<span class="pl-k">const</span> Handler = <span class="pl-c1">require</span>(<span class="pl-s">&apos;iris&apos;</span>).Handler;

<span class="hljs-class"><span class="pl-k">class</span> <span class="pl-ent">Handler1</span> <span class="pl-k">extends</span> <span class="pl-ent">Handler</span> </span>{
    <span class="pl-k">constructor</span>(name) {
        <span class="pl-k">super</span>(name);
    }

    get path() {
        <span class="pl-k">return</span> __filename;
    }

    handle(data) {
        <span class="pl-k">this</span>.logger.info(<span class="pl-s">&apos;[Handler1] Handling data...&apos;</span>);

        <span class="pl-k">return</span> <span class="pl-s">&apos;A response&apos;</span>;
    }
}

<span class="pl-c1">module</span>.exports = <span class="pl-k">new</span> Handler1(<span class="pl-s">&apos;handler1&apos;</span>);
</code></pre>
<h3 id="hooks">Hooks</h3>
<p>You must implement <code>get path()</code> and <code>process()</code>.</p>
<h5 id="sample-hook">Sample hook</h5>
<pre><code class="lang-javascript"><span class="hljs-meta">&apos;use strict&apos;</span>;

<span class="pl-k">const</span> Hook = <span class="pl-c1">require</span>(<span class="pl-s">&apos;iris&apos;</span>).Hook;

<span class="hljs-class"><span class="pl-k">class</span> <span class="pl-ent">Hook1</span> <span class="pl-k">extends</span> <span class="pl-ent">Hook</span> </span>{
    <span class="pl-k">constructor</span>(name) {
        <span class="pl-k">super</span>(name);
    }

    get path() {
        <span class="pl-k">return</span> __filename;
    }

    process(data) {
        <span class="pl-k">this</span>.logger.info(<span class="pl-s">&apos;[Hook1] Running...&apos;</span>);
    }

}

<span class="pl-c1">module</span>.exports = <span class="pl-k">new</span> Hook1(<span class="pl-s">&apos;hook1&apos;</span>);
</code></pre>
<h2 id="requirements">Requirements</h2>
<ul>
<li>Node.js 6.5.0+</li>
</ul>
<h2 id="github">Github</h2>
<p><a href="https://github.com/gcba-iris/iris">Get the code!</a></p>
<hr>
<pre><code>MIT License

Copyright (c) 2016+ Buenos Aires City Government

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the &quot;Software&quot;), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

</code></pre>

        </div>
      </div>
    </div>
  </body>
</html>